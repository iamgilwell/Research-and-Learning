# Solution: Exercise 2 - Multi-Container Pod with Shared Storage
# Demonstrates sidecar pattern with shared volumes

apiVersion: v1
kind: Pod
metadata:
  name: shared-storage-pod
  labels:
    app: dynamic-web
    pattern: sidecar
    tier: frontend
spec:
  containers:
  # Web server container
  - name: web-server
    image: nginx:1.21
    ports:
    - containerPort: 80
      name: http
      protocol: TCP
    
    # Mount shared volume at nginx document root
    volumeMounts:
    - name: shared-content
      mountPath: /usr/share/nginx/html
    - name: nginx-cache
      mountPath: /var/cache/nginx
    - name: nginx-run
      mountPath: /var/run
    
    # Resource management
    resources:
      requests:
        memory: "32Mi"
        cpu: "50m"
      limits:
        memory: "64Mi"
        cpu: "100m"
    
    # Health checks
    livenessProbe:
      httpGet:
        path: /
        port: 80
      initialDelaySeconds: 10
      periodSeconds: 10
    
    readinessProbe:
      httpGet:
        path: /
        port: 80
      initialDelaySeconds: 5
      periodSeconds: 5
    
    # Security context
    securityContext:
      runAsNonRoot: true
      runAsUser: 101
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
  
  # Content generator container (sidecar)
  - name: content-generator
    image: busybox:1.35
    
    # Command to generate dynamic content
    command: ['sh', '-c']
    args:
    - |
      echo "Starting content generator..."
      
      # Create initial content
      cat > /var/www/index.html << 'EOF'
      <!DOCTYPE html>
      <html>
      <head>
          <title>Dynamic Content Pod</title>
          <meta http-equiv="refresh" content="30">
          <style>
              body { font-family: Arial, sans-serif; margin: 40px; }
              .header { color: #2c3e50; }
              .info { background: #ecf0f1; padding: 15px; border-radius: 5px; }
              .timestamp { color: #27ae60; font-weight: bold; }
          </style>
      </head>
      <body>
          <h1 class="header">üöÄ Kubernetes Multi-Container Pod</h1>
          <div class="info">
              <p><strong>Pod Name:</strong> $HOSTNAME</p>
              <p><strong>Generated by:</strong> Content Generator Sidecar</p>
              <p><strong>Served by:</strong> Nginx Web Server</p>
          </div>
      EOF
      
      # Continuous content generation loop
      while true; do
        # Update main page with current timestamp
        cat >> /var/www/index.html << EOF
          <div class="info">
              <h3>üìä Live Status</h3>
              <p class="timestamp">Last Updated: $(date)</p>
              <p><strong>Uptime:</strong> $(uptime -p 2>/dev/null || uptime)</p>
              <p><strong>Container:</strong> content-generator</p>
          </div>
      EOF
        
        # Create status page
        cat > /var/www/status.html << EOF
      <!DOCTYPE html>
      <html>
      <head>
          <title>Pod Status</title>
          <meta http-equiv="refresh" content="10">
      </head>
      <body>
          <h1>üìà Pod Status Dashboard</h1>
          <h2>System Information</h2>
          <ul>
              <li><strong>Hostname:</strong> $HOSTNAME</li>
              <li><strong>Current Time:</strong> $(date)</li>
              <li><strong>Uptime:</strong> $(uptime -p 2>/dev/null || uptime)</li>
              <li><strong>Process Count:</strong> $(ps aux | wc -l)</li>
          </ul>
          
          <h2>Environment Variables</h2>
          <ul>
              <li><strong>Pod Name:</strong> $POD_NAME</li>
              <li><strong>Node Name:</strong> $NODE_NAME</li>
              <li><strong>Namespace:</strong> $POD_NAMESPACE</li>
          </ul>
          
          <h2>Volume Information</h2>
          <ul>
              <li><strong>Mount Point:</strong> /var/www</li>
              <li><strong>Disk Usage:</strong> $(df -h /var/www | tail -1)</li>
              <li><strong>File Count:</strong> $(ls -1 /var/www | wc -l) files</li>
          </ul>
          
          <p><a href="/">‚Üê Back to Main Page</a></p>
      </body>
      </html>
      EOF
        
        # Create API endpoint (JSON)
        cat > /var/www/api.json << EOF
      {
        "status": "healthy",
        "timestamp": "$(date -Iseconds)",
        "pod": {
          "name": "$POD_NAME",
          "namespace": "$POD_NAMESPACE",
          "node": "$NODE_NAME"
        },
        "uptime": "$(uptime -p 2>/dev/null || uptime | cut -d',' -f1)",
        "generator": "content-generator-sidecar"
      }
      EOF
        
        echo "Content updated at $(date)"
        sleep 30
      done
    
    # Environment variables from pod metadata
    env:
    - name: POD_NAME
      valueFrom:
        fieldRef:
          fieldPath: metadata.name
    - name: POD_NAMESPACE
      valueFrom:
        fieldRef:
          fieldPath: metadata.namespace
    - name: NODE_NAME
      valueFrom:
        fieldRef:
          fieldPath: spec.nodeName
    
    # Mount shared volume
    volumeMounts:
    - name: shared-content
      mountPath: /var/www
    
    # Resource management
    resources:
      requests:
        memory: "16Mi"
        cpu: "25m"
      limits:
        memory: "32Mi"
        cpu: "50m"
    
    # Security context
    securityContext:
      runAsNonRoot: true
      runAsUser: 1000
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: true
  
  # Shared volumes
  volumes:
  - name: shared-content
    emptyDir: {}
  - name: nginx-cache
    emptyDir: {}
  - name: nginx-run
    emptyDir: {}
  
  # Pod-level settings
  restartPolicy: Always
  
  # Pod security context
  securityContext:
    fsGroup: 1000
